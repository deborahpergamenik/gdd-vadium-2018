CREATE PROCEDURE [MERCADONEGRO].[BORRAR_FK_Y_TABLE] 
	
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	
	 DECLARE @NOMBRE_FK NVARCHAR(255), 
	 @NOMBRE_TABLA NVARCHAR(255)
	
	DECLARE CURSOR_BORRADO_FK CURSOR FOR (SELECT fk.name, o.name
from SYS.foreign_keys fk inner join sys.schemas s on (fk.schema_id = s.schema_id) inner join sys.objects o on (fk.parent_object_id = o.object_id)
where s.name = N'MERCADONEGRO')
	
	OPEN CURSOR_BORRADO_FK
	FETCH CURSOR_BORRADO_FK INTO @NOMBRE_FK, @NOMBRE_TABLA
		WHILE (@@FETCH_STATUS = 0)
			BEGIN
			
			exec('ALTER TABLE MERCADONEGRO.'+@NOMBRE_TABLA+' DROP CONSTRAINT '+@NOMBRE_FK)
			
			FETCH CURSOR_BORRADO_FK INTO @NOMBRE_FK, @NOMBRE_TABLA
			END
	CLOSE CURSOR_BORRADO_FK
	DEALLOCATE CURSOR_BORRADO_FK
	
	DECLARE CURSOR_BORRADO_TABLAS CURSOR FOR (SELECT T.name
FROM SYS.tables T INNER JOIN SYS.schemas S ON (S.schema_id = T.schema_id)
WHERE S.name = 'MERCADONEGRO')
	
	OPEN CURSOR_BORRADO_TABLAS
	FETCH CURSOR_BORRADO_TABLAS INTO @NOMBRE_TABLA
		WHILE (@@FETCH_STATUS = 0)
			BEGIN
			
			exec('DROP TABLE MERCADONEGRO.'+@NOMBRE_TABLA)
			
			FETCH CURSOR_BORRADO_TABLAS INTO @NOMBRE_TABLA
			END
	CLOSE CURSOR_BORRADO_TABLAS
	DEALLOCATE CURSOR_BORRADO_TABLAS
 
 
	DECLARE CURSOR_BORRADO_FUNCIONES CURSOR FOR (SELECT O.NAME, O.type
FROM SYS.objects O INNER JOIN SYS.schemas S ON (S.schema_id = O.schema_id)
WHERE S.name = N'MERCADONEGRO' AND ( O.type = 'FN' OR O.type='P')
)
	
	OPEN CURSOR_BORRADO_FUNCIONES
	FETCH CURSOR_BORRADO_FUNCIONES INTO @NOMBRE_TABLA, @NOMBRE_FK
		WHILE (@@FETCH_STATUS = 0)
			BEGIN
			IF @NOMBRE_FK = 'FN' 
			BEGIN
				exec('DROP FUNCTION MERCADONEGRO.'+@NOMBRE_TABLA)
			END
			ELSE
			BEGIN
				exec('DROP PROCEDURE MERCADONEGRO.'+@NOMBRE_TABLA)
			END
			
			FETCH CURSOR_BORRADO_FUNCIONES INTO @NOMBRE_TABLA, @NOMBRE_FK
			END
	CLOSE CURSOR_BORRADO_FUNCIONES
	DEALLOCATE CURSOR_BORRADO_FUNCIONES
 
 
END
GO
EXEC MERCADONEGRO.BORRAR_FK_Y_TABLE
GO
DROP SCHEMA MERCADONEGRO
GO